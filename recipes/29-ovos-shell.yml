{{- $build_cores := or .build_cores 4 -}}
{{- $platform := or .platform "rpi4" -}}

architecture: {{ .architecture }}

actions:
  - action: run
    description: Ensure /var/tmp directory
    chroot: true
    command: mkdir -p /var/tmp
  - action: apt
    description: Shell/GUI Dependencies
    packages:
      - git-core
      - g++
      - make
      - cmake
      - extra-cmake-modules
      - gettext
      - pkg-config
      - qml-module-qtwebengine
      - pkg-kde-tools
      - qtbase5-dev
      - qtdeclarative5-dev
      - libkf5kio-dev
      - libqt5websockets5-dev
      - libkf5i18n-dev
      - libkf5notifications-dev
      - libkf5plasma-dev
      - libqt5webview5-dev
      - qtmultimedia5-dev
      - qml-module-qtmultimedia
  - action: overlay
    description: Neon Shell Overlay
    source: ../overlays/29-ovos-shell
    destination: /

{{ if eq $platform "opi5" }}
  - action: run
    description: Patch device path for Orange Pi5
    chroot: True
    command: |
      sed -i -e "s|card1|card0|g" /etc/neon/eglfs.json
{{ end }}

{{ if eq $platform "rpi4" }}
  - action: apt
    description: Mesa unstable
    packages:
      - libegl-mesa0/unstable
      - libglx-mesa0/unstable
      - libgl1-mesa-dri/unstable
      - libdrm-radeon1/unstable
      - libx11-data/unstable
      - libglapi-mesa/unstable
      - libx11-6/unstable
      - libllvm17/unstable
      - libdrm-common/unstable
      - libx11-xcb1/unstable
      - libx11-dev/unstable
      - libdrm2/unstable
      - libdrm-amdgpu1/unstable
      - libdrm-nouveau2/unstable
      - libgbm1/unstable
{{ end }}

  - action: run
    description: Build Keyboard
    chroot: true
    command: |
      dpkg --force-overwrite -i /opt/qtvirtualkeyboard_patch/qtvirtualkeyboard_5.15.6_arm64.deb || exit 10
      rm -rf /opt/qtvirtualkeyboard_patch || exit 10

  - action: run
    description: Build and Install OVOS Shell and Mycroft GUI
    chroot: true
    script: ../scripts/29-build-ovos-shell.sh {{ $build_cores }}
