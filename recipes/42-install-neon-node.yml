{{- $architecture := or .architecture "arm64" -}}
{{- $neon_core := or .neon_core "master" -}}
{{- $default_user := or .default_user "neon" -}}
{{- $device := or .device "mark_2" -}}

architecture: {{ $architecture }}

actions:
  - action: apt
    description: Install dependencies
    packages:
      - curl
      - sox
      - libsox-fmt-mp3
      - portaudio19-dev
      - git
      - libpulse-dev
      - wireless-tools
      - plasma-nm
      - unzip
      - ffmpeg
      - python3-wheel
  - action: overlay
    description: Neon Satellite overlay
    source: ../overlays/42-neon-node
    destination: /

  - action: run
    description: Install Python dependencies and enable service
    chroot: true
    command: |
      export PIPX_HOME=/opt/neon/pipx
      export PIPX_BIN_DIR=/bin
      [ -d ${PIPX_HOME} ] || mkdir -p ${PIPX_HOME}

      pipx install neon-nodes[voice_client]@git+https://github.com/neongeckocom/neon-nodes@FEAT_InitialVoiceClient
      systemctl enable neon-node
      chmod ugo+x /usr/libexec/neon-node.py
      wget https://github.com/OpenVoiceOS/precise-lite-models/raw/master/wakewords/en/hey_mycroft.tflite -O /opt/neon/hey_mycroft.tflite
