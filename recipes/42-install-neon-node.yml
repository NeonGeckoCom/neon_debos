{{- $architecture := or .architecture "arm64" -}}
{{- $neon_core := or .neon_core "master" -}}
{{- $default_user := or .default_user "neon" -}}
{{- $device := or .device "mark_2" -}}

architecture: {{ $architecture }}

actions:
  - action: apt
    description: Install dependencies
    packages:
      - curl
      - sox
      - libsox-fmt-mp3
      - portaudio19-dev
      - git
      - libpulse-dev
      - wireless-tools
      - plasma-nm
      - unzip
      - ffmpeg
      - pipx
      - python3-dev
      - python3-pip
      - python3-wheel
  - action: overlay
    description: Neon Node overlay
    source: ../overlays/42-neon-node
    destination: /

  - action: run
    description: Apply configuration overlay
    chroot: true
    command: |
      wget https://raw.githubusercontent.com/NeonGeckoCom/neon-nodes/FEAT_InitialVoiceClient/neon_nodes/configuration/system.yaml -O /etc/neon/neon.yaml

  - action: run
    description: Install Python dependencies and enable service
    chroot: true
    command: |
      python3 -m venv /opt/neon/venv
      . /opt/neon/venv/bin/activate
      # TODO: Parse branch from `neon_core` var
      pip install neon-nodes[voice-client]@git+https://github.com/neongeckocom/neon-nodes@FEAT_InitialVoiceClient
      systemctl enable neon-node
      chmod ugo+x /usr/libexec/neon-node.py
      wget https://github.com/OpenVoiceOS/precise-lite-models/raw/master/wakewords/en/hey_mycroft.tflite -O /opt/neon/hey_mycroft.tflite

