{{ $suite :=  or .suite "bookworm" }}

architecture: {{ .architecture }}

actions:
  - action: run
    description: Add Raspberry Pi GPG key
    chroot: true
    command: |
      curl https://archive.raspberrypi.org/debian/raspberrypi.gpg.key | apt-key add - 2> /dev/null
  - action: overlay
    description: Raspberrypi apt overlay
    source: ../overlays/03-raspi-apt-repo
  - action: run
    description: Add raspberrypi apt sources
    chroot: true
    command: echo "deb https://archive.raspberrypi.org/debian/ {{ $suite }} main">/etc/apt/sources.list.d/raspberrypi.list
  - action: apt
    description: Raspberry Pi Dependencies
    packages:
      - raspberrypi-bootloader
      - libraspberrypi-dev
      - raspi-config
      - raspi-utils
      - rpi-eeprom
  - action: run
    description: Upgrade packages from RPi repo
    chroot: true
    command: apt upgrade -y
  - action: run
    description: Link firmware
    chroot: true
    command: ln -s /boot/firmware/overlays /boot/overlays