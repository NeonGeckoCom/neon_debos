{{- $architecture := or .architecture "arm64" -}}
{{- $neon_core := or .neon_core "master" -}}
{{- $default_user := or .default_user "neon" -}}
{{- $device := or .device "mark_2" -}}

architecture: {{ $architecture }}

actions:
  - action: apt
    description: Install dependencies
    packages:
      - curl
      - sox
      - libsox-fmt-mp3
      - portaudio19-dev
      - git
      - libpulse-dev
      - wireless-tools
      - plasma-nm
      - unzip
      - ffmpeg
  - action: overlay
    description: Neon Satellite overlay
    source: ../overlays/42-neon-satellite
    destination: /

  - action: run
    description: Install Python dependencies and enable service
    chroot: true
    # TODO: Update to configurable path
    command: |
      python3 -m venv /home/neon/venv
      . /home/neon/venv/bin/activate
      pip install neon-nodes[voice_client]@git+https://github.com/neongeckocom/neon-nodes@FEAT_InitialVoiceClient
      systemctl enable neon-node
      chmod ugo+x /usr/libexec/neon-node.py
      chown -R neon:neon /home/neon
      wget https://github.com/OpenVoiceOS/precise-lite-models/raw/master/wakewords/en/hey_mycroft.tflite -O /opt/neon/hey_mycroft.tflite
