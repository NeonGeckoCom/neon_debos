{{- $architecture := or .architecture "arm64" -}}
{{- $build_cores := or .build_cores 4 -}}
{{- $suite := or .suite "bookworm" -}}

architecture: {{ $architecture }}

actions:
  - action: debootstrap
    suite: {{ $suite }}
    components:
      - main
      - non-free-firmware
    mirror: https://deb.debian.org/debian
    variant: minbase
  - action: apt
    description: Python Build Dependencies
    packages:
      - linux-headers-arm64
      - build-essential
      - zlib1g-dev
      - libncurses5-dev
      - libncursesw5-dev
      - libgdbm-dev
      - libnss3-dev
      - libssl-dev
      - libsqlite3-dev
      - libreadline-dev
      - libffi-dev
      - curl
      - wget
      - llvm
      - libbz2-dev
      - xz-utils
      - tk-dev
      - dpkg

  - action: download
    description: Download Python3.10 source
    url: https://www.python.org/ftp/python/3.10.8/Python-3.10.8.tar.xz
    unpack: true
    name: python

  - action: overlay
    origin: python
    destination: /opt/python

  - action: run
    description: Build Python
    chroot: true
    command: |
      cd /opt/python/Python-3.10.8
      ./configure --enable-optimizations
      make -j{{ $build_cores }}

  - action: run
    description: Copy Python Binaries to Host
    chroot: false
    command: |
      mv "${ROOTDIR}/opt/python/" "/image_build/overlay/16-python_3_10/var/tmp/"
