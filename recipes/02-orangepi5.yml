{{- $architecture := or .architecture "arm64" -}}
{{- $firmware_version := or .firmware_version "master" -}}

architecture: {{ $architecture }}

actions:

  - action: overlay
    description: Add Orange Pi 5 overlay
    source: ../overlays/02-opi5
    destination: /

  - action: apt
    description: Install apt dependencies
    packages:
      - zstd
      - initramfs-tools
      - u-boot-tools
      - u-boot-menu
      - util-linux
      - linux-image-arm64
      - arm-trusted-firmware
      - device-tree-compiler

  - action: run
    description: Define Default Groups
    chroot: true
    command: |
      groupadd gpio
      groupadd pulse
      groupadd pulse-access
      groupadd i2c

  - action: raw
    description: Write idbloader to magic sector
    origin: filesystem
    source: /boot/idbloader.img
    offset: {{ sector 64 }}

  - action: raw
    description: Write u-boot to magic sector
    origin: filesystem
    source: /boot/u-boot.itb
    offset: {{ sector 16384 }}

  - action: run
    description: Build boot.scr and cleanup boot partition
    chroot: true
    command: |
      mkimage -C none -A arm64 -O linux -T script -d /boot/boot.cmd /boot/boot.scr
      rm /boot/idbloader.img
      rm /boot/u-boot.itb

  - action: apt
    description: Install rockchip deb package dependencies
    packages:
      - libssl-dev
      - flex
      - bison
      - libc6-dev
      - gcc
      - make
      - rfkill

  - action: run
    chroot: true
    description: Install kernel headers
    label: dpkg
    command: |
      dpkg -i /var/tmp/*.deb && rm /var/tmp -r
      rm /boot/Image && mv /boot/vmlinuz-*-rockchip-rk3588 /boot/Image
      rm -rf /boot/dtb && mv /boot/dtb-*-rockchip-rk3588 /boot/dtb
      ls -lah /boot

  - action: run
    description: Set hostname
    chroot: true
    command: echo orangepi5 > /etc/hostname
